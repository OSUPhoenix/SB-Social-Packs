<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src ws: wss: https://api.github.com https://raw.githubusercontent.com;
      ">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Rotator</title>
<style>
  :root{
    --bg:#0b0b0e; --text:#ffffff; --accent:#a257ed;
    --card-bg:#141418; --radius:16px; --gap:18px;
    --pad:16px; --shadow:0 8px 24px rgba(0,0,0,.35);
    --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --size:20px;
    /* animation timing */
    --enter: 750ms;
    --exit:  750ms;
    --hold-in: 250ms;   /* logo-only before expand */
    --hold-out: 250ms;  /* logo-only after collapse */
  }
  html,body{height:100%;margin:0;background:transparent;}
  body{display:flex;align-items:center;justify-content:center;font-family:var(--font);color:var(--text);}
  .wrap{display:flex;align-items:center;gap:var(--gap);}

  .card{
    position: relative;
    display:flex; align-items:center; gap:14px;
    background: transparent;
    border-radius: var(--radius);
    padding: var(--pad) calc(var(--pad) * 1.25);
    box-shadow: var(--shadow);
    min-width: 460px;
  }
  .card::before{
    content:"";
    position:absolute; inset:0;
    background: var(--card-bg);
    border: 2px solid var(--accent);
    border-radius: inherit;
    clip-path: inset(0 var(--startRight, 70%) 0 0 round var(--radius));
    opacity: 0;
    z-index: 0;
  }
  .icon, .textwrap { position: relative; z-index: 1; }

  .icon{
    width:48px;height:48px;border-radius:50%;
    display:grid;place-items:center;background:rgba(255,255,255,.06);
    overflow:hidden; flex:0 0 auto;
    border:2px solid var(--accent);
  }
  .icon img{width:100%;height:100%;object-fit:cover;}
  .text{display:flex;flex-direction:column;line-height:1.2}
  .platform{font-size:calc(var(--size) * .85);opacity:.9}
  .handle{font-size:calc(var(--size) * 1.1);font-weight:700;max-width:760px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .card.off { opacity:0; pointer-events:none; display:none; }

  /* ENTER */
  .card.enter::before  { animation: frameReveal var(--enter) ease-out var(--hold-in) forwards; }
  .card.enter .icon    { animation: iconIn     300ms  ease-out    0ms           both; }
  .card.enter .textwrap{ animation: textExpand var(--enter) ease-out calc(var(--hold-in) + 150ms) both; }
  .card.enter .platform{ animation: textFadeIn 350ms  ease-out    calc(var(--hold-in) + 550ms)  both; }
  .card.enter .handle  { animation: textFadeIn 350ms  ease-out    calc(var(--hold-in) + 1050ms) both; }

  /* LEAVE (reverse) */
  .card.leave .handle   { animation: textFadeOut   300ms ease-in   0ms    both; }
  .card.leave .platform { animation: textFadeOut   300ms ease-in   250ms  both; }
  .card.leave .textwrap { animation: textCollapse  var(--exit) ease-in 550ms both; }
  .card.leave::before   { animation: frameHide     var(--exit) ease-in  550ms both; }
  .card.leave .icon     { animation: iconOut       300ms ease-in   calc(550ms + var(--exit) + var(--hold-out)) both; }

  @keyframes frameReveal { from{opacity:0; clip-path: inset(0 var(--startRight,70%) 0 0 round var(--radius));}
                           to  {opacity:1; clip-path: inset(0 0%                   0 0 round var(--radius));} }
  @keyframes frameHide   { from{opacity:1; clip-path: inset(0 0%                   0 0 round var(--radius));}
                           to  {opacity:0; clip-path: inset(0 var(--startRight,70%) 0 0 round var(--radius));} }

  @keyframes iconIn   { from {opacity:0; transform:scale(.9);} to {opacity:1; transform:scale(1);} }
  @keyframes iconOut  { from {opacity:1; transform:scale(1);}  to {opacity:0; transform:scale(.9);} }

  .textwrap{ transform-origin:left center; will-change:transform,opacity; }
  @keyframes textExpand   { from {opacity:0; transform:scaleX(0);} to {opacity:1; transform:scaleX(1);} }
  @keyframes textCollapse { from {opacity:1; transform:scaleX(1);} to {opacity:0; transform:scaleX(0);} }
  @keyframes textFadeIn   { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:translateY(0);} }
  @keyframes textFadeOut  { from {opacity:1; transform:translateY(0);}   to {opacity:0; transform:translateY(4px);} }
</style>
</head>
<body>
  <div class="wrap">
    <div id="card" class="card off">
      <div class="icon" id="iconBox" aria-hidden="true"></div>
      <div class="text textwrap">
        <div class="platform" id="platform"></div>
        <div class="handle" id="handle"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- State ---
  let items = [];
  let idx = 0;
  let timer = null;
  let onMs = 5000, offMs = 0;
  let theme = { bg:"#0b0b0e", text:"#ffffff", accent:"#a257ed", radius:16, size:20 };

  // icon repo configuration (from SB)
  let iconRepo = null;          // { owner, repo, path, branch?, iconSet? }

  const elCard = document.getElementById('card');
  const elPlatform = document.getElementById('platform');
  const elHandle = document.getElementById('handle');
  const elIcon = document.getElementById('iconBox');

  // Built-in SVGs (fallbacks)
  const ICONS = {
    twitch:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h17v11.5l-5 5h-4l-2.5 2.5H7v-2.5H4V3zm14 9V6h-2v6h2zm-5 0V6h-2v6h2z"/></svg>`,
    youtube:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.7-.8-2.4c-.8-.8-1.7-.8-2.1-.9C17.8 2.5 12 2.5 12 2.5s-5.8 0-8.6.4c-.4.1-1.3.1-2.1.9C.7 4.5.5 6.2.5 6.2S.3 8.3.3 10.4v2.2c0 2.1.2 4.2.2 4.2s.2 1.7.8 2.4c.8.8 1.9.8 2.4.9 1.8.2 7.6.4 8.3.4h.2c.7 0 6.5-.2 8.3-.4.5-.1 1.6-.1 2.4-.9.6-.7.8-2.4.8-2.4s.2-2.1.2-4.2v-2.2c0-2.1-.2-4.2-.2-4.2zM9.8 14.7V7.9l6.2 3.4-6.2 3.4z"/></svg>`,
    x:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.2 2h3.1l-6.8 7.7L23 22h-7.2l-4.6-6.1L6 22H2.9l7.3-8.2L1.1 2h7.3l4.2 5.6L18.2 2z"/></svg>`,
    instagram:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm5 5a5 5 0 100 10 5 5 0 000-10zm6.5-.8a1.2 1.2 0 100 2.4 1.2 1.2 0 000-2.4zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>`,
    tiktok:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 8.5c-2 0-4.1-1-5.4-2.7V17a5.8 5.8 0 11-5.9-5.8c.4 0 .9 0 1.3.1v3.3a2.5 2.5 0 10-1.3 4.6A2.5 2.5 0 0014 16V2.8h3.3a6.8 6.8 0 006.7 6.7V13A9.5 9.5 0 0121 8.5z"/></svg>`,
    discord:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.3 4.5c-1.8-.8-3.6-1.4-5.6-1.6l-.3.6c2 .4 3.5 1 5 1.8-2.1-1-4.4-1.5-6.8-1.5S8 4.3 5.9 5.3c1.5-.8 3-1.4 5-1.8l-.3-.6c-2 .2-3.8.8-5.6 1.6C3.4 7 2.6 9.7 2.6 12.4c0 0 1.2 2 4.4 2.1 0 0 .5-.6.9-1.1-1.7-.5-2.3-1.5-2.3-1.5s1 .5 1.4.6c.8.4 1.8.7 3 .9 1.1-.1 2.2-.4 3-.9.5-.2 1-.4 1.4-.6 0 0 .1 0 .1-.1.3-.1.4-.2.4-.2s-.6 1-2.3 1.5c.4.5.9 1.1.9 1.1 3.2-.1 4.4-2.1 4.4-2.1 0-2.7-.8-5.4-2.7-7.9zM9.4 13c-.6 0-1.1-.6-1.1-1.2 0-.7.5-1.2 1.1-1.2s1.1.5 1.1 1.2c0 .6-.5 1.2-1.1 1.2zm5.2 0c-.6 0-1.1-.6-1.1-1.2 0-.7.5-1.2 1.1-1.2s1.1.5 1.1 1.2c0 .6-.5 1.2-1.1 1.2z"/></svg>`,
    facebook:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 22V12h3.3l.5-3.7H13V6.1c0-1 .3-1.6 1.7-1.6h2V1.1C16.4 1 15 1 13.5 1 10.9 1 9 2.7 9 5.6v2.7H6v3.7h3V22h4z"/></svg>`,
    threads:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2zm4.6 10.8c-.2 1.8-1.1 3.2-2.7 4.1-1.4.8-3 .9-4.4.3 0 0 .8-1.1 1-1.3 1 .3 2.1.2 3-.4.9-.6 1.4-1.5 1.6-2.7-1.2-.7-2.6-1-4.3-1.1-.6 0-1.2 0-1.8.1.1-.6.3-1.2.5-1.8.6 0 1.3-.1 2-.1 1.7 0 3.2.3 4.5 1 .1-.7-.1-1.4-.6-2.1-.6-.8-1.6-1.4-3-1.7l.3-1.5c1.9.4 3.2 1.2 4.1 2.4 1 1.2 1.3 2.6 1.2 3.8z"/></svg>`,
    bluesky:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 9.5c2.7-3.5 7.6-8.1 9.4-8.3 1.3-.2 2.1 1.4.3 5-1.1 2.1-3.1 4.4-5.5 6.6 3 .8 5.8 2.7 5.8 5.9 0 1.8-1.1 3.6-2.6 3.6-2.2 0-4-2.1-7.4-6.3-3.4 4.2-5.2 6.3-7.4 6.3C2.1 22.3 1 20.5 1 18.7c0-3.2 2.8-5.1 5.8-5.9-2.4-2.2-4.4-4.5-5.5-6.6-1.8-3.6-1-5.2.3-5 1.8.2 6.7 4.8 9.4 8.3z"/></svg>`
  };

  const BRAND = {
    twitch:   { accent:'#9146FF' },
    youtube:  { accent:'#FF0000' },
    x:        { accent:'#000000' },
    twitter:  { accent:'#000000' },
    instagram:{ accent:'#E1306C' },
    tiktok:   { accent:'#EE1D52' },
    discord:  { accent:'#5865F2' },
    facebook: { accent:'#1877F2' },
    threads:  { accent:'#000000' },
    bluesky:  { accent:'#1185FE' }
  };

  function keyFromPlatform(p){
    const s = (p || '').toLowerCase();
    if (s.includes('twitter') || s === 'x' || s.includes('x /')) return 'x';
    return s.split(' ')[0];
  }

  function applyGlobalTheme() {
    const r = document.documentElement;
    r.style.setProperty('--bg', theme.bg);
    r.style.setProperty('--text', theme.text);
    r.style.setProperty('--accent', theme.accent);
    r.style.setProperty('--radius', theme.radius + 'px');
    r.style.setProperty('--size', theme.size + 'px');
  }
  function applyItemTheme(card, it) {
    const tIn = it.theme || {};
    const brand = BRAND[keyFromPlatform(it.platform)] || {};
    const nextAccent = (tIn.accent ?? brand.accent ?? theme.accent);
    const nextText   = (tIn.text   ?? theme.text);
    const nextBg     = (tIn.bg     ?? null);

    document.documentElement.style.setProperty('--accent', nextAccent);
    document.documentElement.style.setProperty('--text',   nextText);
    card.style.background = nextBg ? nextBg : 'var(--card-bg)';
  }

  // GitHub Icon Pack helpers
  function iconUrlFromPack(key) {
    if (!iconRepo || !iconRepo.iconSet) return null;
    const branch = iconRepo.branch || 'main';
    return `https://raw.githubusercontent.com/${iconRepo.owner}/${iconRepo.repo}/${branch}/${iconRepo.path}/${iconRepo.iconSet}/${key}.svg`;
  }

  // Compute clip start ratio so the frame "reveals" from the icon
  function computeStartRight() {
    const cs = getComputedStyle(document.documentElement);
    const pad = parseFloat(cs.getPropertyValue('--pad')) || 16;
    const icon = 48;
    const collapsed = (pad * 2) + icon;
    const full = elCard.getBoundingClientRect().width || 600;
    const ratio = Math.max(0.2, Math.min(0.9, collapsed / full));
    const startRight = Math.round((1 - ratio) * 100);
    elCard.style.setProperty('--startRight', startRight + '%');
  }

  function render(i) {
    if (!items.length) return;
    idx = (i + items.length) % items.length;
    const it = items[idx];

    elPlatform.textContent = it.platform || '';
    elHandle.textContent   = it.display || it.url || '';

    // icon
    elIcon.innerHTML = '';
    const raw = (it.icon || '').toLowerCase();

    if (raw.startsWith('pack:')) {
      const key = raw.slice(5);
      const url = iconUrlFromPack(key);
      if (url) { const img = document.createElement('img'); img.src = url; elIcon.appendChild(img); }
      else if (ICONS[key]) elIcon.innerHTML = ICONS[key];
      else elIcon.textContent = (it.platform||'?').slice(0,1);
    } else if (raw.startsWith('builtin:')) {
      const key = raw.slice(8);
      if (ICONS[key]) elIcon.innerHTML = ICONS[key];
      else elIcon.textContent = (it.platform||'?').slice(0,1);
    } else if (it.icon) {
      const img = document.createElement('img'); img.src = it.icon; elIcon.appendChild(img);
    } else {
      elIcon.textContent = (it.platform||'?').slice(0,1);
    }

    elCard.style.cursor = it.url ? 'pointer' : 'default';
    elCard.onclick = () => { if (it.url) window.open(it.url, '_blank'); };

    applyItemTheme(elCard, it);

    // (re)measure for the reveal
    computeStartRight();
  }

  // Animation control
  const ENTER_TOTAL_MS = 750;
  const LEAVE_TOTAL_MS = 1850; // 550ms delay + 750 collapse + 250 hold + 300 iconOut

  function clearTimers(){ if (timer){ clearTimeout(timer); timer=null; } }
  function showCard(){
    elCard.style.display = '';
    elCard.classList.remove('off','leave');
    void elCard.offsetWidth; // reflow
    elCard.classList.add('enter');
  }
  function hideCard(){
    elCard.classList.remove('enter');
    elCard.classList.add('leave');
    setTimeout(() => {
      elCard.classList.add('off');
      elCard.style.display = 'none';
    }, LEAVE_TOTAL_MS);
  }

  function cycleOnce(){
    clearTimers();
    showCard();
    timer = setTimeout(() => {
      hideCard();
      timer = setTimeout(() => {
        render(idx + 1);
        showCard();
        cycleOnce();
      }, offMs);
    }, onMs);
  }

  // Command router
  function applyCommand(args) {
    switch (args.command) {
      case 'config':
        items = Array.isArray(args.items) ? args.items : [];
        onMs  = Math.max(0, Math.floor((args.timeOnSeconds ?? 5) * 1000));
        offMs = Math.max(0, Math.floor((args.timeOffSeconds ?? 0) * 1000));
        theme = {
          bg:     args.theme?.bg    ?? theme.bg,
          text:   args.theme?.text  ?? theme.text,
          accent: args.theme?.accent?? theme.accent,
          radius: Number(args.theme?.radius ?? theme.radius),
          size:   Number(args.theme?.size   ?? theme.size)
        };
        if (args.iconRepo) iconRepo = args.iconRepo;
        applyGlobalTheme(); render(0);
        break;
      case 'start': clearTimers(); cycleOnce(); break;
      case 'stop':  clearTimers(); hideCard();  break;
      case 'next':  render(idx + 1); showCard(); break;
    }
  }

  function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }

  // WebSocket (matches your lizard overlay)
  const wsUrl = (() => {
    const m = location.search.match(/[?&]ws=([^&]+)/);
    const u = m ? decodeURIComponent(m[1]) : 'ws://127.0.0.1:8080/';
    return u.endsWith('/') ? u : (u + '/');
  })();

  (function connectSB(){
    try {
      const ws = new WebSocket(wsUrl);
      ws.addEventListener('open', () => {
        ws.send(JSON.stringify({ request:'Subscribe', id:'social-rotator', events:{ General:['Custom'] } }));
        console.log('[rotator] WS open + subscribed', wsUrl);
      });
      ws.addEventListener('message', ev => {
        const msg = typeof ev.data === 'string' ? safeParse(ev.data) : null;
        if (!msg) return;

        // Expected: { event:{source:'General',type:'Custom'}, data:{ eventName, useArgs, args } }
        if (msg.event?.source === 'General' && msg.event?.type === 'Custom') {
          const d = msg.data || {};
          // your TriggerCodeEvent passes eventName + args
          if (d.eventName === 'SocialRotator') {
            const a = d.args || {};
            // normalize if someone sends {event:"SocialRotator", ...}
            if (!a.command && d.command) a.command = d.command;
            if (a.command) applyCommand(a);
          }
        }

        // extra fallbacks (if raw payloads are used)
        if (msg.event === 'SocialRotator' && msg.command) applyCommand(msg);
        if (msg.command) applyCommand(msg);
      });
      ws.addEventListener('error', e => console.warn('[rotator] WS error', e));
      ws.addEventListener('close', () => console.warn('[rotator] WS closed'));
    } catch (e) {
      console.warn('[rotator] WS init failed', e);
    }
  })();

  // initial paint
  applyGlobalTheme();
  render(0);
})();
</script>
</body>
</html>
